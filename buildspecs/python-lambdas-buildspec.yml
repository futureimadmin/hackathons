version: 0.2

phases:
  install:
    runtime-versions:
      python: 3.11
    commands:
      - echo "Python version..."
      - python --version
      - pip --version

  pre_build:
    commands:
      - echo "Environment - $ENVIRONMENT"
      - echo "Project Name - $PROJECT_NAME"

  build:
    commands:
      - echo "Building and deploying Python Lambda functions..."
      - echo "Checking environment variables..."
      - echo "PROJECT_NAME - $PROJECT_NAME"
      - echo "ENVIRONMENT - $ENVIRONMENT"
      - echo "LAMBDA_ROLE_ARN - $LAMBDA_ROLE_ARN"
      - echo "AWS_DEFAULT_REGION - $AWS_DEFAULT_REGION"
      - |
        if [ -z "$LAMBDA_ROLE_ARN" ]; then
          echo "ERROR: LAMBDA_ROLE_ARN environment variable is not set"
          exit 1
        fi
      - echo "Deploying Analytics Service..."
      - cd analytics-service/src
      - echo "Installing dependencies with size optimization..."
      - pip install -r ../requirements.txt -t . --quiet --no-cache-dir --compile
      - echo "Removing unnecessary files to reduce size..."
      - find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
      - find . -name "*.pyc" -delete 2>/dev/null || true
      - find . -name "*.pyo" -delete 2>/dev/null || true
      - find . -type d -name "*.dist-info" -exec rm -rf {} + 2>/dev/null || true
      - find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
      - zip -r analytics-lambda.zip . -q -x "*.pyc" "*/__pycache__/*" "*.dist-info/*"
      - echo "Package size check..."
      - ls -lh analytics-lambda.zip
      - |
        SIZE=$(stat -f%z analytics-lambda.zip 2>/dev/null || stat -c%s analytics-lambda.zip)
        if [ $SIZE -gt 52428800 ]; then
          echo "ERROR: Package too large ($SIZE bytes). Lambda limit is 50MB."
          exit 1
        fi
        echo "Package size OK: $SIZE bytes"
      - |
        FUNCTION_NAME="${PROJECT_NAME}-analytics-${ENVIRONMENT}"
        echo "Processing function: $FUNCTION_NAME"
        if aws lambda get-function --function-name "$FUNCTION_NAME" --region "$AWS_DEFAULT_REGION" 2>/dev/null; then
          echo "Updating Analytics Lambda..."
          aws lambda update-function-code \
            --function-name "$FUNCTION_NAME" \
            --zip-file fileb://analytics-lambda.zip \
            --region "$AWS_DEFAULT_REGION"
        else
          echo "Creating Analytics Lambda..."
          aws lambda create-function \
            --function-name "$FUNCTION_NAME" \
            --runtime python3.11 \
            --role "$LAMBDA_ROLE_ARN" \
            --handler handler.lambda_handler \
            --zip-file fileb://analytics-lambda.zip \
            --timeout 60 \
            --memory-size 512 \
            --environment Variables="{ENVIRONMENT=$ENVIRONMENT}" \
            --region "$AWS_DEFAULT_REGION"
        fi
      - cd ../..
      - echo "Deploying Market Intelligence Hub..."
      - cd ai-systems/market-intelligence-hub/src
      - echo "Installing dependencies with size optimization..."
      - pip install -r ../requirements.txt -t . --quiet --no-cache-dir --compile
      - echo "Removing unnecessary files to reduce size..."
      - find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
      - find . -name "*.pyc" -delete 2>/dev/null || true
      - find . -name "*.pyo" -delete 2>/dev/null || true
      - find . -type d -name "*.dist-info" -exec rm -rf {} + 2>/dev/null || true
      - find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
      - zip -r market-intelligence-lambda.zip . -q -x "*.pyc" "*/__pycache__/*" "*.dist-info/*"
      - echo "Package size check..."
      - ls -lh market-intelligence-lambda.zip
      - |
        SIZE=$(stat -f%z market-intelligence-lambda.zip 2>/dev/null || stat -c%s market-intelligence-lambda.zip)
        echo "Package size: $SIZE bytes"
        
        FUNCTION_NAME="${PROJECT_NAME}-market-intelligence-${ENVIRONMENT}"
        echo "Processing function: $FUNCTION_NAME"
        
        if [ $SIZE -gt 52428800 ]; then
          echo "Package too large for direct upload. Using S3 deployment..."
          
          # Upload to S3
          S3_BUCKET="${PROJECT_NAME}-pipeline-artifacts-${ENVIRONMENT}"
          S3_KEY="lambda-packages/market-intelligence-lambda.zip"
          aws s3 cp market-intelligence-lambda.zip s3://$S3_BUCKET/$S3_KEY --region "$AWS_DEFAULT_REGION"
          
          if aws lambda get-function --function-name "$FUNCTION_NAME" --region "$AWS_DEFAULT_REGION" 2>/dev/null; then
            echo "Updating Market Intelligence Lambda from S3..."
            aws lambda update-function-code \
              --function-name "$FUNCTION_NAME" \
              --s3-bucket "$S3_BUCKET" \
              --s3-key "$S3_KEY" \
              --region "$AWS_DEFAULT_REGION"
          else
            echo "Creating Market Intelligence Lambda from S3..."
            aws lambda create-function \
              --function-name "$FUNCTION_NAME" \
              --runtime python3.11 \
              --role "$LAMBDA_ROLE_ARN" \
              --handler handler.lambda_handler \
              --code S3Bucket="$S3_BUCKET",S3Key="$S3_KEY" \
              --timeout 60 \
              --memory-size 1024 \
              --environment Variables="{ENVIRONMENT=$ENVIRONMENT}" \
              --region "$AWS_DEFAULT_REGION"
          fi
        else
          echo "Package size OK for direct upload: $SIZE bytes"
          if aws lambda get-function --function-name "$FUNCTION_NAME" --region "$AWS_DEFAULT_REGION" 2>/dev/null; then
            echo "Updating Market Intelligence Lambda..."
            aws lambda update-function-code \
              --function-name "$FUNCTION_NAME" \
              --zip-file fileb://market-intelligence-lambda.zip \
              --region "$AWS_DEFAULT_REGION"
          else
            echo "Creating Market Intelligence Lambda..."
            aws lambda create-function \
              --function-name "$FUNCTION_NAME" \
              --runtime python3.11 \
              --role "$LAMBDA_ROLE_ARN" \
              --handler handler.lambda_handler \
              --zip-file fileb://market-intelligence-lambda.zip \
              --timeout 60 \
              --memory-size 1024 \
              --environment Variables="{ENVIRONMENT=$ENVIRONMENT}" \
              --region "$AWS_DEFAULT_REGION"
          fi
        fi
      - cd ../../..
      - echo "Deploying Demand Insights Engine..."
      - cd ai-systems/demand-insights-engine/src
      - echo "Installing dependencies with size optimization..."
      - pip install -r ../requirements.txt -t . --quiet --no-cache-dir --compile
      - echo "Removing unnecessary files to reduce size..."
      - find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
      - find . -name "*.pyc" -delete 2>/dev/null || true
      - find . -name "*.pyo" -delete 2>/dev/null || true
      - find . -type d -name "*.dist-info" -exec rm -rf {} + 2>/dev/null || true
      - find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
      - zip -r demand-insights-lambda.zip . -q -x "*.pyc" "*/__pycache__/*" "*.dist-info/*"
      - echo "Package size check..."
      - ls -lh demand-insights-lambda.zip
      - |
        SIZE=$(stat -f%z demand-insights-lambda.zip 2>/dev/null || stat -c%s demand-insights-lambda.zip)
        echo "Package size: $SIZE bytes"
        
        FUNCTION_NAME="${PROJECT_NAME}-demand-insights-${ENVIRONMENT}"
        echo "Processing function: $FUNCTION_NAME"
        
        if [ $SIZE -gt 52428800 ]; then
          echo "Package too large for direct upload. Using S3 deployment..."
          
          S3_BUCKET="${PROJECT_NAME}-pipeline-artifacts-${ENVIRONMENT}"
          S3_KEY="lambda-packages/demand-insights-lambda.zip"
          aws s3 cp demand-insights-lambda.zip s3://$S3_BUCKET/$S3_KEY --region "$AWS_DEFAULT_REGION"
          
          if aws lambda get-function --function-name "$FUNCTION_NAME" --region "$AWS_DEFAULT_REGION" 2>/dev/null; then
            echo "Updating Demand Insights Lambda from S3..."
            aws lambda update-function-code \
              --function-name "$FUNCTION_NAME" \
              --s3-bucket "$S3_BUCKET" \
              --s3-key "$S3_KEY" \
              --region "$AWS_DEFAULT_REGION"
          else
            echo "Creating Demand Insights Lambda from S3..."
            aws lambda create-function \
              --function-name "$FUNCTION_NAME" \
              --runtime python3.11 \
              --role "$LAMBDA_ROLE_ARN" \
              --handler handler.lambda_handler \
              --code S3Bucket="$S3_BUCKET",S3Key="$S3_KEY" \
              --timeout 60 \
              --memory-size 1024 \
              --environment Variables="{ENVIRONMENT=$ENVIRONMENT}" \
              --region "$AWS_DEFAULT_REGION"
          fi
        else
          echo "Package size OK for direct upload: $SIZE bytes"
          if aws lambda get-function --function-name "$FUNCTION_NAME" --region "$AWS_DEFAULT_REGION" 2>/dev/null; then
            echo "Updating Demand Insights Lambda..."
            aws lambda update-function-code \
              --function-name "$FUNCTION_NAME" \
              --zip-file fileb://demand-insights-lambda.zip \
              --region "$AWS_DEFAULT_REGION"
          else
            echo "Creating Demand Insights Lambda..."
            aws lambda create-function \
              --function-name "$FUNCTION_NAME" \
              --runtime python3.11 \
              --role "$LAMBDA_ROLE_ARN" \
              --handler handler.lambda_handler \
              --zip-file fileb://demand-insights-lambda.zip \
              --timeout 60 \
              --memory-size 1024 \
              --environment Variables="{ENVIRONMENT=$ENVIRONMENT}" \
              --region "$AWS_DEFAULT_REGION"
          fi
        fi
      - cd ../../..
      - echo "Deploying Compliance Guardian..."
      - cd ai-systems/compliance-guardian/src
      - echo "Installing dependencies with size optimization..."
      - pip install -r ../requirements.txt -t . --quiet --no-cache-dir --compile
      - echo "Removing unnecessary files to reduce size..."
      - find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
      - find . -name "*.pyc" -delete 2>/dev/null || true
      - find . -name "*.pyo" -delete 2>/dev/null || true
      - find . -type d -name "*.dist-info" -exec rm -rf {} + 2>/dev/null || true
      - find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
      - zip -r compliance-lambda.zip . -q -x "*.pyc" "*/__pycache__/*" "*.dist-info/*"
      - echo "Package size check..."
      - ls -lh compliance-lambda.zip
      - |
        SIZE=$(stat -f%z compliance-lambda.zip 2>/dev/null || stat -c%s compliance-lambda.zip)
        echo "Package size: $SIZE bytes"
        
        FUNCTION_NAME="${PROJECT_NAME}-compliance-guardian-${ENVIRONMENT}"
        echo "Processing function: $FUNCTION_NAME"
        
        if [ $SIZE -gt 52428800 ]; then
          echo "Package too large for direct upload. Using S3 deployment..."
          
          S3_BUCKET="${PROJECT_NAME}-pipeline-artifacts-${ENVIRONMENT}"
          S3_KEY="lambda-packages/compliance-lambda.zip"
          aws s3 cp compliance-lambda.zip s3://$S3_BUCKET/$S3_KEY --region "$AWS_DEFAULT_REGION"
          
          if aws lambda get-function --function-name "$FUNCTION_NAME" --region "$AWS_DEFAULT_REGION" 2>/dev/null; then
            echo "Updating Compliance Guardian Lambda from S3..."
            aws lambda update-function-code \
              --function-name "$FUNCTION_NAME" \
              --s3-bucket "$S3_BUCKET" \
              --s3-key "$S3_KEY" \
              --region "$AWS_DEFAULT_REGION"
          else
            echo "Creating Compliance Guardian Lambda from S3..."
            aws lambda create-function \
              --function-name "$FUNCTION_NAME" \
              --runtime python3.11 \
              --role "$LAMBDA_ROLE_ARN" \
              --handler handler.lambda_handler \
              --code S3Bucket="$S3_BUCKET",S3Key="$S3_KEY" \
              --timeout 60 \
              --memory-size 1024 \
              --environment Variables="{ENVIRONMENT=$ENVIRONMENT}" \
              --region "$AWS_DEFAULT_REGION"
          fi
        else
          echo "Package size OK for direct upload: $SIZE bytes"
          if aws lambda get-function --function-name "$FUNCTION_NAME" --region "$AWS_DEFAULT_REGION" 2>/dev/null; then
            echo "Updating Compliance Guardian Lambda..."
            aws lambda update-function-code \
              --function-name "$FUNCTION_NAME" \
              --zip-file fileb://compliance-lambda.zip \
              --region "$AWS_DEFAULT_REGION"
          else
            echo "Creating Compliance Guardian Lambda..."
            aws lambda create-function \
              --function-name "$FUNCTION_NAME" \
              --runtime python3.11 \
              --role "$LAMBDA_ROLE_ARN" \
              --handler handler.lambda_handler \
              --zip-file fileb://compliance-lambda.zip \
              --timeout 60 \
              --memory-size 1024 \
              --environment Variables="{ENVIRONMENT=$ENVIRONMENT}" \
              --region "$AWS_DEFAULT_REGION"
          fi
        fi
      - cd ../../..
      - echo "Deploying Retail Copilot..."
      - cd ai-systems/retail-copilot/src
      - echo "Installing dependencies with size optimization..."
      - pip install -r ../requirements.txt -t . --quiet --no-cache-dir --compile
      - echo "Removing unnecessary files to reduce size..."
      - find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
      - find . -name "*.pyc" -delete 2>/dev/null || true
      - find . -name "*.pyo" -delete 2>/dev/null || true
      - find . -type d -name "*.dist-info" -exec rm -rf {} + 2>/dev/null || true
      - find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
      - zip -r retail-copilot-lambda.zip . -q -x "*.pyc" "*/__pycache__/*" "*.dist-info/*"
      - echo "Package size check..."
      - ls -lh retail-copilot-lambda.zip
      - |
        SIZE=$(stat -f%z retail-copilot-lambda.zip 2>/dev/null || stat -c%s retail-copilot-lambda.zip)
        if [ $SIZE -gt 52428800 ]; then
          echo "ERROR: Package too large ($SIZE bytes). Lambda limit is 50MB."
          exit 1
        fi
        echo "Package size OK: $SIZE bytes"
      - |
        FUNCTION_NAME="${PROJECT_NAME}-retail-copilot-${ENVIRONMENT}"
        echo "Processing function: $FUNCTION_NAME"
        if aws lambda get-function --function-name "$FUNCTION_NAME" --region "$AWS_DEFAULT_REGION" 2>/dev/null; then
          echo "Updating Retail Copilot Lambda..."
          aws lambda update-function-code \
            --function-name "$FUNCTION_NAME" \
            --zip-file fileb://retail-copilot-lambda.zip \
            --region "$AWS_DEFAULT_REGION"
        else
          echo "Creating Retail Copilot Lambda..."
          aws lambda create-function \
            --function-name "$FUNCTION_NAME" \
            --runtime python3.11 \
            --role "$LAMBDA_ROLE_ARN" \
            --handler handler.lambda_handler \
            --zip-file fileb://retail-copilot-lambda.zip \
            --timeout 60 \
            --memory-size 1024 \
            --environment Variables="{ENVIRONMENT=$ENVIRONMENT}" \
            --region "$AWS_DEFAULT_REGION"
        fi
      - cd ../../..
      - echo "Deploying Global Market Pulse..."
      - cd ai-systems/global-market-pulse/src
      - echo "Installing dependencies with size optimization..."
      - pip install -r ../requirements.txt -t . --quiet --no-cache-dir --compile
      - echo "Removing unnecessary files to reduce size..."
      - find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
      - find . -name "*.pyc" -delete 2>/dev/null || true
      - find . -name "*.pyo" -delete 2>/dev/null || true
      - find . -type d -name "*.dist-info" -exec rm -rf {} + 2>/dev/null || true
      - find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
      - zip -r global-market-pulse-lambda.zip . -q -x "*.pyc" "*/__pycache__/*" "*.dist-info/*"
      - echo "Package size check..."
      - ls -lh global-market-pulse-lambda.zip
      - |
        SIZE=$(stat -f%z global-market-pulse-lambda.zip 2>/dev/null || stat -c%s global-market-pulse-lambda.zip)
        if [ $SIZE -gt 52428800 ]; then
          echo "ERROR: Package too large ($SIZE bytes). Lambda limit is 50MB."
          exit 1
        fi
        echo "Package size OK: $SIZE bytes"
      - |
        FUNCTION_NAME="${PROJECT_NAME}-global-market-pulse-${ENVIRONMENT}"
        echo "Processing function: $FUNCTION_NAME"
        if aws lambda get-function --function-name "$FUNCTION_NAME" --region "$AWS_DEFAULT_REGION" 2>/dev/null; then
          echo "Updating Global Market Pulse Lambda..."
          aws lambda update-function-code \
            --function-name "$FUNCTION_NAME" \
            --zip-file fileb://global-market-pulse-lambda.zip \
            --region "$AWS_DEFAULT_REGION"
        else
          echo "Creating Global Market Pulse Lambda..."
          aws lambda create-function \
            --function-name "$FUNCTION_NAME" \
            --runtime python3.11 \
            --role "$LAMBDA_ROLE_ARN" \
            --handler handler.lambda_handler \
            --zip-file fileb://global-market-pulse-lambda.zip \
            --timeout 60 \
            --memory-size 1024 \
            --environment Variables="{ENVIRONMENT=$ENVIRONMENT}" \
            --region "$AWS_DEFAULT_REGION"
        fi
      - cd ../../..

  post_build:
    commands:
      - echo "Python Lambdas deployment completed"

artifacts:
  files:
    - '**/*.zip'
  name: PythonLambdasOutput

cache:
  paths:
    - '/root/.cache/pip/**/*'